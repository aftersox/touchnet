<!DOCTYPE html>
<html>
	<head>
		<title>Testing D3 and Touch Dragging</title>
		<script src="../d3.v3.min.js"></script>
		<script src="../jquery-1.8.2.min.js"></script>
		<!-- icon font: http://mfglabs.github.com/mfglabs-iconset/ -->
		<link rel="stylesheet" href="css/mfglabs_iconset.css">
		<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,300italic,700' rel='stylesheet' type='text/css'>
		<style>
			body {
				font-family: 'Open Sans Condensed', sans-serif;
			}
			#nodeDataEntry {
				position:absolute;
				display:none;
				background: #EEE;
				padding: 5px;
				border-radius: 5px;
			}
			.modelOverlay {
				position: fixed;
				width: 100%;
				height: 100%;
				top: 0px;
				left: 0px;
				background-color: #EEE;
			}
			#toolBox {
				position: fixed;
				top: 10px;
				left: 10px;
				background-color: #DDE;
				border-radius: 5px;
				padding: 5px;
			}
			.toolUnselected {
				color: #999;
			}
			.toolSelected {
				color: #C99;
			}
			.icon2x {
				cursor: hand;
				cursor: pointer;
			}
			.iconSubmit {
				color: #999;
			}
			.iconSubmit:hover {
				color: #6A6;
			}
			.iconCancel {
				color: #999;
			}
			.iconCancel:hover {
				color: #A66;
			}
			.ndnm {
				cursor: default;
			}
		</style>
	</head>
	<body>
		<div id='container'>
			<div id = 'netspace'>
				<div id = 'toolBox'>
					<i class="toolIcon addNode icon-users icon2x toolUnselected"></i>
					<i class="toolIcon removeElement icon-trash_can icon2x toolUnselected"></i>
					<i class="toolIcon editText icon-letter icon2x toolUnselected"></i>
					<i class="toolIcon addLink icon-vector icon2x toolUnselected"></i>
				</div>
				<div id = 'nodeDataEntry'>
					<form id = "nodeDataForm">
						<table><tr>
							<td>Name</td>
							<td><input type="text" name="nodename" id = "t_nodename" /></td>
							<td><i id = "nodeDataFormSubmit" class="icon-check icon2x iconSubmit"></td>
							<td><i id = "nodeDataFormCancel" class="icon-cross_mark icon2x iconCancel"></td>
						</tr></table>
					</form>
				</div>
			</div>
		</div>
		<script>
			// Set the default tool
			var hh = $(window).height(),
				ww = $(window).width(),
				tool = "none",
				d_R = 20,
				ndnew = {},
				dt = [];
			
			
			// Bind events and what not
			$(document).ready( function() {
					$(".toolIcon").bind('click', function() {
							var el = this;
							tool = "none";
							$(".toolIcon").removeClass("toolSelected");
							$(".toolIcon").addClass("toolUnselected");
							if ( $(el).hasClass("toolUnselected") ) {
								$(el).removeClass("toolUnselected");
								$(el).addClass("toolSelected");
								setTool(el);
							}
					});
				
					$("#nodeDataFormSubmit").click( function() {
						$("#nodeDataForm").submit();
					});
					
					$("#nodeDataFormSubmit").click( function() {
						$("#t_nodename").val("");
						$("#nodeDataEntry").css("display","none");
					});
					
					$("#nodeDataForm").submit( function() {
						console.log("add a node");
						ndnew.nm = $("#t_nodename").val();
						console.log(ndnew);
						addNode(ndnew);
						$("#t_nodename").val("");
						$("#nodeDataEntry").css("display","none");
						return false;
					});

				
				});
			
			
			// build the svg workspace
			// when a user clicks on the svg space, call a tool action

			var svg = d3.select('#netspace').append('svg:svg')
				.attr('height',hh)
				.attr('width',ww)
				.on('touchstart',toolact)
				.on('click',toolact);
			
			// When the user selects a tool, set the global tool variable
			
			function setTool(el) {
				if($(el).hasClass("addNode"))
					tool = "addNode";
				if($(el).hasClass("removeElement"))
					tool = "removeElement";
				if($(el).hasClass("editText"))
					tool = "editText";
				if($(el).hasClass("addLink"))
					tool = "addLink";
			}
				
			

				
			// Tool actions
			
			function toolact() {
				var ts = d3.mouse(this);
				var coord = {top:ts[1],left:ts[0]};
				if ( tool === "addNode" ) {
					createNode(coord);
				}
			}
			
			// Create a node
			function createNode(coord) {
				d3.select("#nodeDataEntry")
					.style("display","block")
					.style("top",coord.top+"px")
					.style("left",coord.left+"px");
				$("#t_nodename").focus();
				
				ndnew = {nm: "",
					xpos: coord.left,
					ypos: coord.top,
					rr: d_R};
			}
			
			function addNode(nd) {
				dt.push(nd);
				update();
			}
			
			function makedot(d) {
				var ts = d3.touches(this);
				dt.push({nm: 'x0',
					xpos: ts[0][0],
					ypos: ts[1][0],
					rr: 30});
				update();
			}
			
			function mousedot(d) {
				var ts = d3.mouse(this);
				d3.select("#nodeDataEntry")
					.style("display","block")
					.style("top",ts[1]+"px")
					.style("left",ts[0]+"px");
				dt.push({nm: 'x0',
					xpos: ts[0],
					ypos: ts[1],
					rr: 30});
				//console.log(ts[0]);
				update();	
			}
				
			var drag = d3.behavior.drag()
				.on('drag',dragmove);
			
			function getFormData() {
				d3.select("#netspace")
					.append("");
			}
			
			function getNodeIndex(nmf) {
				for(var i = 0; i < dt.length; i++) {
					if (dt[i].nm == nmf)
						return i;
				}
				return false;
			}
			
			
			
			//The data
			/*var dt = [{nm: 'p1', xpos: 150, ypos: 150, rr: 20},
				{nm: 'p2', xpos: 200, ypos: 200, rr: 30}];
			*/
						
			function update() {
				var ns = svg.selectAll('g.ns')
					.data(dt, function(d) { return d.nm; });
				var nsEnter = ns.enter().insert('g')
					.attr('class','ns')
					.attr('transform', function(d) { return('translate('+ d.xpos + ',' + d.ypos + ')');})
					.call(drag);
				
				ns.on('click',function(d) {
					// remove the node
					if(tool === "removeElement") {
						var ix = getNodeIndex(d.nm);
						dt.splice(ix,1);
						update();
					}
				});
				
				nsEnter.append('circle')
					.attr('class','circ')
					.style('fill','#AAF')
					.style('fill-opacity','0.7')
					.attr('r',function(d) { return (d.rr); });
				
				nsEnter.append('text')
					.attr('class','ndnm')
					.attr('x','-5px')
					.attr('y','5px')
					.text(function(d) { return(d.nm); });
				
				ns.exit().remove();
			}
			update();
			
			function dragmove(d) {
				d3.select(this)
					.attr('transform', 'translate('+ (d.xpos = d3.event.x) + ',' + (d.xpos = d3.event.y) + ')');
			}
				
		</script>
	</body>
</html>
